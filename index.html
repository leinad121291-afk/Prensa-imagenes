<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoria de Im√°genes - Con Autoavance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 900px;
            width: 100%;
        }

        .title {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .phase-title {
            color: #666;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .section-title {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .image-display {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 3px solid #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .image-display img {
            max-width: 100%;
            max-height: 350px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .name-display {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 3px solid #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .name-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            min-width: 300px;
        }

        .name-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .finish-button {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }
        
        .finish-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #c82333 0%, #dc3545 100%) !important;
        }
        
        .pause-button {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }
        
        .pause-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #e0a800 0%, #ffc107 100%) !important;
        }
        
        .resume-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }
        
        .resume-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%) !important;
        }
        
        .fullscreen-button {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullscreen-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%) !important;
        }
        
        .fullscreen-button.fullscreen {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%) !important;
        }
        
        .fullscreen-button.fullscreen:hover {
            background: linear-gradient(135deg, #7d3c98 0%, #8e44ad 100%) !important;
        }

        .timer {
            font-size: 1.2rem;
            color: #666;
            margin: 10px 0;
        }

        .progress-indicator {
            font-size: 1.1rem;
            color: #666;
            margin: 15px 0;
        }

        .hidden {
            display: none;
        }

        .timer-config {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .timer-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .timer-option label {
            font-size: 1.1rem;
            color: #333;
        }

        .timer-select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: #f8f9fa;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .timer-select:hover {
            background: #e9ecef;
        }
        
        .timer-select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .summary {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #bbdefb;
        }

        .summary h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .summary p {
            margin: 8px 0;
            color: #333;
        }

        .time-info {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #bbdefb;
        }

        .time-item {
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid #bbdefb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-item:last-child {
            border-bottom: none;
        }

        .time-item strong {
            color: #1976d2;
            font-size: 1rem;
        }

        .time-item span {
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .result-message {
            font-size: 1.5rem;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .correct-result {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .incorrect-result {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .final-score {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #bbdefb;
            text-align: center;
        }
        
        .score-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .score-number {
            color: #1976d2;
        }
        
        .score-label {
            color: #666;
            font-size: 1.5rem;
        }
        
        .score-percentage {
            font-size: 2rem;
            color: #28a745;
            font-weight: bold;
        }
        
        .round-breakdown {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .rounds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .round-item {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .round-item.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .round-item.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .performance-summary {
            background: #fff3cd;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #ffeaa7;
        }
        
        .performance-summary h4 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        .performance-summary p {
            margin: 8px 0;
            color: #333;
        }

        .image-upload {
            margin: 20px 0;
            text-align: center;
        }

        .image-upload input[type="file"] {
            display: none;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .image-preview img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .view-options {
            margin-top: 20px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 2px solid #b3d9ff;
        }

        .view-options h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .view-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .view-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            font-size: 1rem;
            padding: 12px 20px;
        }

        .view-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%);
        }

        .image-gallery {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .gallery-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: transform 0.2s;
        }

        .gallery-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .gallery-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .gallery-item .image-name {
            font-size: 0.9rem;
            color: #333;
            font-weight: bold;
            word-break: break-word;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }
            
            .timer-config {
                flex-direction: column;
                align-items: center;
            }
            
            .image-display {
                min-height: 300px;
            }
            
            .image-display img {
                max-height: 250px;
            }
            
            .finish-button {
                font-size: 1rem;
                padding: 12px 24px;
            }
            
            .pause-button, .resume-button {
                font-size: 1rem;
                padding: 12px 24px;
            }
            
            .fullscreen-button {
                font-size: 1rem;
                padding: 6px 10px;
                top: 10px;
                right: 10px;
                min-width: 35px;
                min-height: 35px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <button class="fullscreen-button" id="fullscreen-btn" onclick="toggleFullscreen()" title="Pantalla Completa">‚õ∂</button>
        <h1 class="title">Memoria de Im√°genes</h1>
        
        <!-- Fase de Configuraci√≥n -->
        <div id="setup-phase">
            <h2 class="phase-title">Configuraci√≥n del Juego</h2>
            
            <!-- Carga de Im√°genes -->
            <div class="section">
                <h3 class="section-title">Cargar Im√°genes</h3>
                <p>Selecciona las im√°genes que quieres memorizar:</p>
                <div class="image-upload">
                    <input type="file" id="image-files" multiple accept="image/*" onchange="loadImagesFromFiles()">
                    <button class="button" onclick="document.getElementById('image-files').click()">Seleccionar Im√°genes</button>
                </div>
                <div id="image-preview" class="image-preview"></div>
                
                <!-- Opciones de Visualizaci√≥n -->
                <div class="view-options" id="view-options" style="display: none;">
                    <h4 class="section-title">Visualizar Im√°genes</h4>
                    <p>¬øC√≥mo quieres ver las im√°genes antes de empezar?</p>
                                     <div class="view-buttons">
                     <button class="button view-btn" onclick="viewImagesAlphabetical()">Ver por Orden Alfab√©tico</button>
                     <button class="button view-btn" onclick="viewImagesRandom()">Ver Aleatoriamente</button>
                 </div>
                </div>
            </div>
            
            <!-- Galer√≠a de Im√°genes -->
            <div class="image-gallery" id="image-gallery" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 class="section-title" style="margin: 0;">Galer√≠a de Im√°genes</h3>
                    <button class="button" onclick="hideGallery()" style="background: #dc3545;">Ocultar Galer√≠a</button>
                </div>
                <p id="gallery-description">Visualizando im√°genes en orden alfab√©tico</p>
                <div class="gallery-grid" id="gallery-grid"></div>
                <button class="button" onclick="hideGallery()" style="margin-top: 15px;">Ocultar Galer√≠a</button>
            </div>
            
                                     <!-- Configuraci√≥n de Modo de Juego -->
            <div class="section">
                <h3 class="section-title">Modo de Juego</h3>
                <p>Selecciona c√≥mo quieres que avance el juego:</p>
                <div class="timer-config">
                    <div class="timer-option">
                        <input type="radio" id="auto-advance-mode" name="game-mode" value="auto-advance" checked>
                        <label for="auto-advance-mode">Modo Autoavance</label>
                    </div>
                    <div class="timer-option">
                        <input type="radio" id="manual-mode" name="game-mode" value="manual">
                        <label for="manual-mode">Modo Manual</label>
                    </div>
                </div>
            </div>
            
            <!-- Configuraci√≥n de Duraci√≥n del Juego -->
            <div class="section">
                <h3 class="section-title">Duraci√≥n del Juego</h3>
                <p>Selecciona c√≥mo quieres que termine el juego:</p>
                <div class="timer-config">
                    <div class="timer-option">
                        <input type="radio" id="time-limit-mode" name="duration-mode" value="time-limit" checked>
                        <label for="time-limit-mode">Jugar por tiempo (volver al principio cuando se acaben las im√°genes)</label>
                    </div>
                    <div class="timer-option">
                        <input type="radio" id="until-end-mode" name="duration-mode" value="until-end">
                        <label for="until-end-mode">Jugar hasta que se acaben las im√°genes</label>
                    </div>
                </div>
            </div>
            
            <!-- Configuraci√≥n de Autoavance -->
            <div class="section" id="auto-advance-config">
                <h3 class="section-title">Tiempo de Autoavance</h3>
                <p>Configura el tiempo de autoavance para cada fase (puedes usar decimales como 1.2, 0.4, etc.)</p>
                <div class="timer-config">
                    <div class="timer-option">
                        <label for="name-auto-advance-time">Tiempo para nombre de imagen (segundos):</label>
                        <input type="number" id="name-auto-advance-time" class="timer-select" min="0.1" max="60" step="0.1" value="" placeholder="1.2">
                    </div>
                    <div class="timer-option">
                        <label for="image-auto-advance-time">Tiempo para imagen (segundos):</label>
                        <input type="number" id="image-auto-advance-time" class="timer-select" min="0.1" max="60" step="0.1" value="" placeholder="0.4">
                    </div>
                </div>
            </div>

            <!-- Configuraci√≥n de Tiempo Total (solo en modo por tiempo) -->
            <div class="section" id="total-time-config" style="display: none;">
                <h3 class="section-title">Tiempo Total de Juego</h3>
                <p>Configura el tiempo total que quieres jugar (en minutos):</p>
                <div class="timer-config">
                    <div class="timer-option">
                        <label for="total-game-minutes">Tiempo total (minutos):</label>
                        <input type="number" id="total-game-minutes" class="timer-select" min="1" max="120" step="0.5" value="" placeholder="5">
                    </div>
                </div>
            </div>
            
            <!-- Informaci√≥n de Tiempos -->
            <div class="section">
                <h3 class="section-title">Informaci√≥n de Tiempos</h3>
                <div class="time-info">
                    <div class="time-item">
                        <strong>Tiempo total para finalizar la partida:</strong>
                        <span id="total-game-time">Calculando...</span>
                    </div>
                    <div class="time-item">
                        <strong>Tiempo por imagen:</strong>
                        <span id="time-per-image">1.2s + 0.4s</span>
                    </div>
                    <div class="time-item">
                        <strong>N√∫mero de im√°genes:</strong>
                        <span id="total-images">5 im√°genes</span>
                    </div>
                    <div class="time-item" id="cycles-info" style="display: none;">
                        <strong>Ciclos completos estimados:</strong>
                        <span id="estimated-cycles">Calculando...</span>
                    </div>
                </div>
            </div>

            <!-- Resumen de Configuraci√≥n -->
            <div class="summary" id="config-summary">
                <h3>Resumen de Configuraci√≥n</h3>
                <p id="summary-images">Im√°genes: 5</p>
                                 <p id="summary-timer">Autoavance: 1.2s (nombre) + 0.4s (imagen)</p>
                 <p id="summary-total">Tiempo total: 8 segundos</p>
            </div>
            
            <button class="button" id="start-game-btn" onclick="startGame()" disabled>Comenzar Juego</button>
            <p style="font-size: 0.9rem; color: #666; margin-top: 15px;">üí° Presiona <strong>F11</strong> o usa el bot√≥n ‚õ∂ en la esquina superior derecha para pantalla completa</p>
        </div>

        <!-- Fase de Preparaci√≥n (NOMBRE) -->
        <div id="preparation-phase" class="hidden">
            <h2 class="phase-title">Fase de Preparaci√≥n</h2>
            <div class="timer" id="prep-timer">Tiempo restante: 2 segundos</div>
            <div class="name-display" id="name-display">
                <div class="name-card">
                    <h3 id="current-image-name">Nombre de la imagen</h3>
                </div>
            </div>
            <div class="progress-indicator" id="prep-progress">Nombre 1 de 5</div>
            <p id="preparation-info">Lee el nombre de la imagen que vas a memorizar.</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">üí° Presiona <strong>Escape</strong> para finalizar la partida en cualquier momento</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">üí° Presiona <strong>F11</strong> para alternar pantalla completa</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;" id="order-info">üîÑ En modo aleatorio, el orden cambia en cada ciclo</p>
            <div style="margin: 20px 0;" id="prep-navigation" style="display: none;">
                <button class="button" id="prep-prev-btn" onclick="previousImage()" disabled>‚Üê Anterior</button>
                <button class="button" id="prep-next-btn" onclick="nextImage()">Siguiente ‚Üí</button>
            </div>
            <div style="margin: 20px 0;">
                <button class="button pause-button" id="prep-pause-btn" onclick="pauseGame()" style="display: none;">‚è∏Ô∏è Pausar</button>
                <button class="button resume-button" id="prep-resume-btn" onclick="resumeGame()" style="display: none;">‚ñ∂Ô∏è Reanudar</button>
                <button class="button finish-button" onclick="finishGame()">Finalizar Partida</button>
            </div>
        </div>

        <!-- Fase de Memorizaci√≥n (IMAGEN) -->
        <div id="memorization-phase" class="hidden">
            <h2 class="phase-title">Fase de Memorizaci√≥n</h2>
            <div class="timer" id="timer">Tiempo restante: 3 segundos</div>
            <div class="image-display" id="image-display">
                <img id="current-image" src="" alt="Imagen para memorizar">
            </div>
            <div class="progress-indicator" id="progress">Imagen 1 de 5</div>
            <p id="memorization-info">Ahora memoriza la imagen correspondiente al nombre que le√≠ste.</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">üí° Presiona <strong>Escape</strong> para finalizar la partida en cualquier momento</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">üí° Presiona <strong>F11</strong> para alternar pantalla completa</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;" id="order-info">üîÑ En modo aleatorio, el orden cambia en cada ciclo</p>
            <div style="margin: 20px 0;" id="mem-navigation" style="display: none;">
                <button class="button" id="mem-prev-btn" onclick="previousImage()" disabled>‚Üê Anterior</button>
                <button class="button" id="mem-next-btn" onclick="nextImage()">Siguiente ‚Üí</button>
            </div>
            <div style="margin: 20px 0;">
                <button class="button pause-button" id="mem-pause-btn" onclick="pauseGame()" style="display: none;">‚è∏Ô∏è Pausar</button>
                <button class="button resume-button" id="mem-resume-btn" onclick="resumeGame()" style="display: none;">‚ñ∂Ô∏è Reanudar</button>
                <button class="button finish-button" onclick="finishGame()">Finalizar Partida</button>
            </div>
        </div>

        <!-- Fase de Resultado -->
        <div id="result-phase" class="hidden">
            <h2 class="phase-title">¬°Juego Completado!</h2>
            <div id="result-message"></div>
            <div>
                <button class="button" onclick="resetGame()" id="new-game-btn">Men√∫</button>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin-top: 15px;">üí° Presiona <strong>F11</strong> o usa el bot√≥n ‚õ∂ en la esquina superior derecha para pantalla completa</p>
        </div>
        

    </div>

    <script>
                         // Variables del juego
        let gameState = 'setup';
        let currentImageIndex = 0;
        let timer = 0;
        let nameAutoAdvanceTime = 0;
        let imageAutoAdvanceTime = 0;
        let timerInterval;
        let gameMode = 'auto-advance'; // 'auto-advance' o 'manual'
        let isPreparationPhase = true;
        
        // Variables para el sistema de duraci√≥n
        let durationMode = 'time-limit'; // 'time-limit' o 'until-end'
        let totalGameMinutes = 0;
        let totalGameSeconds = 0;
        let gameStartTime = 0;
        let cyclesCompleted = 0;
        let totalImagesSeen = 0;
        
        // Variables para el sistema de pausa
        let isPaused = false;
        let pauseStartTime = 0;
        let totalPausedTime = 0;
        let phaseStartTime = 0;
        let phasePausedTime = 0;
        
        // Array de im√°genes (se cargar√°n din√°micamente)
        let images = [];
        let imageNames = [];
        let originalImageOrder = []; // Para mantener el orden original
        let gameImageOrder = []; // Para el orden que se usar√° en el juego
        let gameImageNames = []; // Para los nombres en el orden del juego
        let currentGameMode = 'alphabetical'; // 'alphabetical' o 'random'
        
        // Funci√≥n para cargar im√°genes desde archivos
        function loadImagesFromFiles() {
            const fileInput = document.getElementById('image-files');
            const files = fileInput.files;
            const preview = document.getElementById('image-preview');
            
            if (files.length === 0) {
                alert('Por favor selecciona al menos una imagen');
                return;
            }
            
            // Limpiar la vista previa para mostrar todas las im√°genes
            preview.innerHTML = '';
            
            // Mostrar todas las im√°genes existentes en la vista previa
            if (images.length > 0) {
                images.forEach((image, index) => {
                    const img = document.createElement('img');
                    img.src = image;
                    img.alt = imageNames[index];
                    preview.appendChild(img);
                });
            }
            
            // Crear un array de promesas para manejar la carga as√≠ncrona
            const loadPromises = [];
            const validFiles = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    validFiles.push(file);
                }
            }
            
            // Crear arrays temporales para mantener el orden correcto
            const tempImages = new Array(validFiles.length);
            const tempNames = new Array(validFiles.length);
            
            validFiles.forEach((file, index) => {
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                tempNames[index] = fileName;
                
                const promise = new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempImages[index] = e.target.result;
                        
                        // Crear previsualizaci√≥n
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = fileName;
                        preview.appendChild(img);
                        
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
                
                loadPromises.push(promise);
            });
            
            // Esperar a que todas las im√°genes se carguen
            Promise.all(loadPromises).then(() => {
                // Agregar las nuevas im√°genes a las existentes
                images = images.concat(tempImages);
                imageNames = imageNames.concat(tempNames);
                
                // Actualizar el orden del juego solo si no hay un orden establecido
                // o si estamos en modo alfab√©tico (para mantener consistencia)
                if (gameImageOrder.length === 0 || currentGameMode === 'alphabetical') {
                    gameImageOrder = [...images];
                    gameImageNames = [...imageNames];
                    currentGameMode = 'alphabetical'; // Por defecto, orden alfab√©tico
                } else {
                    // Si hay un orden aleatorio establecido, agregar las nuevas im√°genes al final
                    gameImageOrder = gameImageOrder.concat(tempImages);
                    gameImageNames = gameImageNames.concat(tempNames);
                }
                
                updateSummary();
                validateGameStart();
                document.getElementById('view-options').style.display = 'block';
                // Verificaci√≥n de sincronizaci√≥n completada
            });
        }

                         // Configurar modo de juego
        document.getElementById('auto-advance-mode').addEventListener('change', function() {
            if (this.checked) {
                gameMode = 'auto-advance';
                document.getElementById('auto-advance-config').style.display = 'block';
                updateSummary();
                validateGameStart();
            }
        });
        
        document.getElementById('manual-mode').addEventListener('change', function() {
            if (this.checked) {
                gameMode = 'manual';
                document.getElementById('auto-advance-config').style.display = 'none';
                updateSummary();
                validateGameStart();
            }
        });
        
        // Configurar modo de duraci√≥n
        document.getElementById('time-limit-mode').addEventListener('change', function() {
            if (this.checked) {
                durationMode = 'time-limit';
                document.getElementById('total-time-config').style.display = 'block';
                document.getElementById('cycles-info').style.display = 'block';
                updateSummary();
                validateGameStart();
            }
        });
        
        document.getElementById('until-end-mode').addEventListener('change', function() {
            if (this.checked) {
                durationMode = 'until-end';
                document.getElementById('total-time-config').style.display = 'none';
                document.getElementById('cycles-info').style.display = 'none';
                updateSummary();
                validateGameStart();
            }
        });
        
        // Configurar tiempo de autoavance para nombres
        document.getElementById('name-auto-advance-time').addEventListener('input', function() {
            if (this.value === '') {
                nameAutoAdvanceTime = 0;
                updateSummary();
                return;
            }
            
            nameAutoAdvanceTime = parseFloat(this.value) || 0;
            updateSummary();
        });
        
        // Configurar tiempo de autoavance para im√°genes
        document.getElementById('image-auto-advance-time').addEventListener('input', function() {
            if (this.value === '') {
                imageAutoAdvanceTime = 0;
                updateSummary();
                validateGameStart();
                return;
            }
            
            imageAutoAdvanceTime = parseFloat(this.value) || 0;
            updateSummary();
            validateGameStart();
        });
        
        // Establecer valores por defecto cuando los campos est√©n vac√≠os
        document.getElementById('name-auto-advance-time').addEventListener('blur', function() {
            if (!this.value || this.value === '') {
                this.value = '1.2';
                nameAutoAdvanceTime = 1.2;
                updateSummary();
                validateGameStart();
            }
        });
        
        document.getElementById('image-auto-advance-time').addEventListener('blur', function() {
            if (!this.value || this.value === '') {
                this.value = '0.4';
                imageAutoAdvanceTime = 0.4;
                updateSummary();
                validateGameStart();
            }
        });
        
        // Configurar tiempo total de juego
        document.getElementById('total-game-minutes').addEventListener('input', function() {
            if (this.value === '') {
                totalGameMinutes = 0;
                totalGameSeconds = 0;
                updateSummary();
                validateGameStart();
                return;
            }
            
            totalGameMinutes = parseFloat(this.value) || 0;
            totalGameSeconds = totalGameMinutes * 60;
            updateSummary();
            validateGameStart();
        });
        
        document.getElementById('total-game-minutes').addEventListener('blur', function() {
            if (!this.value || this.value === '') {
                this.value = '5';
                totalGameMinutes = 5;
                totalGameSeconds = 300;
                updateSummary();
                validateGameStart();
            }
        });

                         // Actualizar resumen
        function updateSummary() {
            if (gameMode === 'auto-advance') {
                const timePerImage = nameAutoAdvanceTime + imageAutoAdvanceTime;
                const totalTime = images.length * timePerImage;
                document.getElementById('summary-images').textContent = `Im√°genes: ${images.length}`;
                
                // Manejar campos vac√≠os en el resumen
                const nameTimeText = nameAutoAdvanceTime > 0 ? `${nameAutoAdvanceTime}s` : '(escribe tiempo)';
                const imageTimeText = imageAutoAdvanceTime > 0 ? `${imageAutoAdvanceTime}s` : '(escribe tiempo)';
                document.getElementById('summary-timer').textContent = `Autoavance: ${nameTimeText} (nombre) + ${imageTimeText} (imagen)`;
                
                if (nameAutoAdvanceTime > 0 && imageAutoAdvanceTime > 0) {
                    document.getElementById('time-per-image').textContent = `${nameAutoAdvanceTime}s + ${imageAutoAdvanceTime}s`;
                    
                    // Actualizar informaci√≥n seg√∫n el modo de duraci√≥n
                    if (durationMode === 'time-limit') {
                        if (totalGameMinutes > 0) {
                            const estimatedCycles = Math.floor(totalGameSeconds / totalTime);
                            document.getElementById('summary-total').textContent = `Duraci√≥n: ${totalGameMinutes} minutos (${estimatedCycles} ciclos estimados)`;
                            document.getElementById('total-game-time').textContent = `${totalGameMinutes} minutos`;
                            document.getElementById('estimated-cycles').textContent = `${estimatedCycles} ciclos`;
                        } else {
                            document.getElementById('summary-total').textContent = `Duraci√≥n: (escribe tiempo)`;
                            document.getElementById('total-game-time').textContent = `(escribe tiempo)`;
                            document.getElementById('estimated-cycles').textContent = `(calculando...)`;
                        }
                    } else {
                        document.getElementById('summary-total').textContent = `Duraci√≥n: Hasta que se acaben las im√°genes`;
                        document.getElementById('total-game-time').textContent = `Hasta el final`;
                        document.getElementById('estimated-cycles').textContent = `1 ciclo`;
                    }
                } else {
                    document.getElementById('summary-total').textContent = `Duraci√≥n: (configura los tiempos)`;
                    document.getElementById('total-game-time').textContent = `(configura los tiempos)`;
                    document.getElementById('time-per-image').textContent = `${nameTimeText} + ${imageTimeText}`;
                    document.getElementById('estimated-cycles').textContent = `(calculando...)`;
                }
            } else {
                document.getElementById('summary-images').textContent = `Im√°genes: ${images.length}`;
                document.getElementById('summary-timer').textContent = `Modo: Manual (navegaci√≥n libre)`;
                
                if (durationMode === 'time-limit') {
                    if (totalGameMinutes > 0) {
                        document.getElementById('summary-total').textContent = `Duraci√≥n: ${totalGameMinutes} minutos`;
                        document.getElementById('total-game-time').textContent = `${totalGameMinutes} minutos`;
                    } else {
                        document.getElementById('summary-total').textContent = `Duraci√≥n: (escribe tiempo)`;
                        document.getElementById('total-game-time').textContent = `(escribe tiempo)`;
                    }
                } else {
                    document.getElementById('summary-total').textContent = `Duraci√≥n: Hasta que se acaben las im√°genes`;
                    document.getElementById('total-game-time').textContent = `Hasta el final`;
                }
                
                document.getElementById('time-per-image').textContent = `Manual`;
            }
            
            document.getElementById('total-images').textContent = `${images.length} im√°genes`;
            
            // Habilitar/deshabilitar bot√≥n de inicio
            validateGameStart();
        }
        
        // Funci√≥n para pausar el juego
        function pauseGame() {
            if (isPaused) return; // Ya est√° pausado
            
            isPaused = true;
            pauseStartTime = Date.now();
            phasePausedTime = Date.now();
            
            // Pausar el timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // Mostrar bot√≥n de reanudar y ocultar bot√≥n de pausar
            const pauseBtn = isPreparationPhase ? document.getElementById('prep-pause-btn') : document.getElementById('mem-pause-btn');
            const resumeBtn = isPreparationPhase ? document.getElementById('prep-resume-btn') : document.getElementById('mem-resume-btn');
            
            if (pauseBtn) pauseBtn.style.display = 'none';
            if (resumeBtn) resumeBtn.style.display = 'inline-block';
            
            // Mostrar mensaje de pausa
            const timerElement = isPreparationPhase ? document.getElementById('prep-timer') : document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = '‚è∏Ô∏è JUEGO PAUSADO';
            }
            
            console.log('Juego pausado');
        }
        
        // Funci√≥n para alternar pantalla completa
        function toggleFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            if (!document.fullscreenElement) {
                // Entrar en pantalla completa
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
                
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Salir Pantalla Completa';
                fullscreenBtn.classList.add('fullscreen');
            } else {
                // Salir de pantalla completa
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Pantalla Completa';
                fullscreenBtn.classList.remove('fullscreen');
            }
        }
        
        // Event listener para detectar cambios en pantalla completa
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('msfullscreenchange', updateFullscreenButton);
        
        // Funci√≥n para actualizar el bot√≥n seg√∫n el estado de pantalla completa
        function updateFullscreenButton() {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Salir Pantalla Completa';
                fullscreenBtn.classList.add('fullscreen');
            } else {
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Pantalla Completa';
                fullscreenBtn.classList.remove('fullscreen');
            }
        }
        
        // Funci√≥n para cambiar el orden aleatoriamente
        function shuffleGameOrder() {
            // Crear array de objetos con √≠ndice original
            const imageData = imageNames.map((name, index) => ({
                name: name,
                image: images[index],
                originalIndex: index
            }));
            
            // Mezclar aleatoriamente usando Fisher-Yates
            for (let i = imageData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [imageData[i], imageData[j]] = [imageData[j], imageData[i]];
            }
            
            // Actualizar el orden del juego
            gameImageOrder = imageData.map(item => item.image);
            gameImageNames = imageData.map(item => item.name);
            
            // Mostrar informaci√≥n visual del cambio de orden
            const orderInfoElements = document.querySelectorAll('#order-info');
            orderInfoElements.forEach(element => {
                element.style.display = 'block';
                element.textContent = 'üîÑ Orden aleatorio cambiado para este ciclo';
                
                // Ocultar el mensaje despu√©s de 3 segundos
                setTimeout(() => {
                    element.textContent = 'üîÑ En modo aleatorio, el orden cambia en cada ciclo';
                }, 3000);
            });
        }
        
        // Funci√≥n para reanudar el juego
        function resumeGame() {
            if (!isPaused) return; // No est√° pausado
            
            isPaused = false;
            
            // Calcular tiempo pausado
            const currentTime = Date.now();
            const pauseDuration = currentTime - pauseStartTime;
            totalPausedTime += pauseDuration;
            
            // Ajustar tiempo de inicio de la fase
            const phasePauseDuration = currentTime - phasePausedTime;
            phaseStartTime += phasePauseDuration;
            
            // Ocultar bot√≥n de reanudar y mostrar bot√≥n de pausar
            const pauseBtn = isPreparationPhase ? document.getElementById('prep-pause-btn') : document.getElementById('mem-pause-btn');
            const resumeBtn = isPreparationPhase ? document.getElementById('prep-resume-btn') : document.getElementById('mem-resume-btn');
            
            if (pauseBtn) pauseBtn.style.display = 'inline-block';
            if (resumeBtn) resumeBtn.style.display = 'none';
            
            // Reiniciar timer
            if (gameMode === 'auto-advance') {
                startTimer();
            } else if (durationMode === 'time-limit') {
                startManualTimer();
            }
            
            console.log('Juego reanudado');
        }
        
        // Timer para modo manual (solo mostrar tiempo total)
        function startManualTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                // No actualizar si est√° pausado
                if (isPaused) return;
                
                const totalElapsedTime = ((Date.now() - gameStartTime) - totalPausedTime) / 1000;
                const totalRemainingTime = Math.max(0, totalGameSeconds - totalElapsedTime);
                const totalRemainingMinutes = Math.floor(totalRemainingTime / 60);
                const totalRemainingSeconds = Math.floor(totalRemainingTime % 60);
                
                const timeDisplay = `${totalRemainingMinutes}:${totalRemainingSeconds.toString().padStart(2, '0')}`;
                
                if (isPreparationPhase) {
                    document.getElementById('prep-timer').textContent = `Tiempo total restante: ${timeDisplay}`;
                } else {
                    document.getElementById('timer').textContent = `Tiempo total restante: ${timeDisplay}`;
                }
                
                // Verificar si se agot√≥ el tiempo
                if (totalRemainingTime <= 0) {
                    clearInterval(timerInterval);
                    finishGame();
                    return;
                }
            }, 1000); // Actualizar cada segundo
        }
        
        // Funci√≥n para validar si el juego puede comenzar
        function validateGameStart() {
            const startButton = document.getElementById('start-game-btn');
            if (!startButton) return;
            
            // Verificar si se han cargado im√°genes
            const hasImages = images.length > 0;
            
            // Verificar si los campos de tiempo est√°n completos en modo autoavance
            let hasValidTimes = true;
            if (gameMode === 'auto-advance') {
                hasValidTimes = nameAutoAdvanceTime > 0 && imageAutoAdvanceTime > 0;
            }
            
            // Verificar si el tiempo total est√° configurado en modo por tiempo
            let hasValidDuration = true;
            if (durationMode === 'time-limit') {
                hasValidDuration = totalGameMinutes > 0;
            }
            
            const canStart = hasImages && hasValidTimes && hasValidDuration;
            
            // Aplicar estilos visuales al bot√≥n
            if (canStart) {
                startButton.style.opacity = '1';
                startButton.style.cursor = 'pointer';
                startButton.disabled = false;
            } else {
                startButton.style.opacity = '0.6';
                startButton.style.cursor = 'not-allowed';
                startButton.disabled = true;
            }
        }

        // Inicializar resumen
        updateSummary();
        validateGameStart();
        
        // Mostrar la secci√≥n de tiempo total al cargar la p√°gina ya que "jugar por tiempo" est√° marcado por defecto
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('total-time-config').style.display = 'block';
            document.getElementById('cycles-info').style.display = 'block';
        });

        // Funci√≥n para visualizar im√°genes en orden alfab√©tico
        function viewImagesAlphabetical() {
            if (images.length === 0) {
                alert('Primero debes cargar algunas im√°genes');
                return;
            }

            console.log('=== VISUALIZACI√ìN ALFAB√âTICA ===');
            console.log('Nombres originales:', imageNames);
            console.log('N√∫mero de im√°genes:', images.length);

            // Crear array de objetos con √≠ndice original
            const imageData = imageNames.map((name, index) => ({
                name: name,
                image: images[index],
                originalIndex: index
            }));

            // Ordenar alfab√©ticamente por nombre
            imageData.sort((a, b) => a.name.localeCompare(b.name));

            // Actualizar el orden del juego
            gameImageOrder = imageData.map(item => item.image);
            gameImageNames = imageData.map(item => item.name);
            currentGameMode = 'alphabetical';

            console.log('Orden alfab√©tico:', imageData.map(item => item.name));
            console.log('Verificaci√≥n de datos:');
            imageData.forEach((item, index) => {
                console.log(`Posici√≥n ${index}: Nombre="${item.name}", √çndice original=${item.originalIndex}`);
            });
            console.log('Orden del juego actualizado:', gameImageNames);
            displayGallery(imageData, 'alfab√©tico');
        }

        // Funci√≥n para visualizar im√°genes aleatoriamente
        function viewImagesRandom() {
            if (images.length === 0) {
                alert('Primero debes cargar algunas im√°genes');
                return;
            }

            console.log('=== VISUALIZACI√ìN ALEATORIA ===');
            console.log('Nombres originales:', imageNames);
            console.log('N√∫mero de im√°genes:', images.length);

            // Crear array de objetos con √≠ndice original
            const imageData = imageNames.map((name, index) => ({
                name: name,
                image: images[index],
                originalIndex: index
            }));

            // Mezclar aleatoriamente usando Fisher-Yates
            for (let i = imageData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [imageData[i], imageData[j]] = [imageData[j], imageData[i]];
            }

            // Actualizar el orden del juego
            gameImageOrder = imageData.map(item => item.image);
            gameImageNames = imageData.map(item => item.name);
            currentGameMode = 'random';

            console.log('Orden aleatorio:', imageData.map(item => item.name));
            console.log('Verificaci√≥n de datos:');
            imageData.forEach((item, index) => {
                console.log(`Posici√≥n ${index}: Nombre="${item.name}", √çndice original=${item.originalIndex}`);
            });
            console.log('Orden del juego actualizado:', gameImageNames);
            displayGallery(imageData, 'aleatorio');
        }

        // Funci√≥n para mostrar la galer√≠a
        function displayGallery(imageData, orderType) {
            const gallery = document.getElementById('image-gallery');
            const galleryGrid = document.getElementById('gallery-grid');
            const description = document.getElementById('gallery-description');

            description.textContent = `Visualizando im√°genes en orden ${orderType}`;
            galleryGrid.innerHTML = '';

            imageData.forEach((item, index) => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                galleryItem.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="image-name">${item.name}</div>
                    <div style="font-size: 0.8rem; color: #666;">Posici√≥n original: ${item.originalIndex + 1}</div>
                `;
                galleryGrid.appendChild(galleryItem);
            });

            gallery.style.display = 'block';
            
            // Ocultar bot√≥n de "Mostrar Galer√≠a" si existe
            const showGalleryBtn = document.getElementById('show-gallery-btn');
            if (showGalleryBtn) {
                showGalleryBtn.style.display = 'none';
            }
        }

        // Funci√≥n para ocultar la galer√≠a
        function hideGallery() {
            document.getElementById('image-gallery').style.display = 'none';
            
            // Mostrar bot√≥n de "Mostrar Galer√≠a" en el men√∫ principal
            const setupPhase = document.getElementById('setup-phase');
            if (!setupPhase.classList.contains('hidden')) {
                // Verificar si ya existe el bot√≥n para evitar duplicados
                let showGalleryBtn = document.getElementById('show-gallery-btn');
                if (!showGalleryBtn) {
                    showGalleryBtn = document.createElement('button');
                    showGalleryBtn.className = 'button';
                    showGalleryBtn.id = 'show-gallery-btn';
                    showGalleryBtn.onclick = showGallery;
                    showGalleryBtn.textContent = 'Mostrar Galer√≠a';
                    showGalleryBtn.style.marginTop = '15px';
                    showGalleryBtn.style.background = '#28a745';
                    
                    // Insertar despu√©s de las opciones de visualizaci√≥n
                    const viewOptions = document.getElementById('view-options');
                    if (viewOptions) {
                        viewOptions.appendChild(showGalleryBtn);
                    }
                }
                showGalleryBtn.style.display = 'inline-block';
            }
        }
        
        // Funci√≥n para mostrar la galer√≠a
        function showGallery() {
            document.getElementById('image-gallery').style.display = 'block';
            
            // Ocultar bot√≥n de "Mostrar Galer√≠a"
            const showGalleryBtn = document.getElementById('show-gallery-btn');
            if (showGalleryBtn) {
                showGalleryBtn.style.display = 'none';
            }
        }

        // Funci√≥n de depuraci√≥n para verificar el estado
        function debugState() {
            console.log('=== ESTADO ACTUAL ===');
            console.log('Im√°genes cargadas:', images.length);
            console.log('Nombres de im√°genes:', imageNames);
            console.log('Orden del juego:', gameImageNames);
            console.log('√çndice actual:', currentImageIndex);
            console.log('Fase de preparaci√≥n:', isPreparationPhase);
            console.log('Estado del juego:', gameState);
            
            if (images.length > 0) {
                console.log('Verificaci√≥n de sincronizaci√≥n original:');
                for (let i = 0; i < Math.min(images.length, 5); i++) {
                    console.log(`√çndice ${i}: Nombre="${imageNames[i]}", Imagen="${images[i].substring(0, 50)}..."`);
                }
                if (images.length > 5) {
                    console.log(`... y ${images.length - 5} im√°genes m√°s`);
                }
                
                console.log('Verificaci√≥n de orden del juego:');
                for (let i = 0; i < Math.min(gameImageOrder.length, 5); i++) {
                    console.log(`√çndice ${i}: Nombre="${gameImageNames[i]}", Imagen="${gameImageOrder[i].substring(0, 50)}..."`);
                }
                if (gameImageOrder.length > 5) {
                    console.log(`... y ${gameImageOrder.length - 5} im√°genes m√°s`);
                }
            }
            console.log('=====================');
        }

                // Configurar captura global de teclas
        function setupGlobalKeyCapture() {
            function handleKeyPress(e) {
                // Solo procesar si estamos en fase de preparaci√≥n o memorizaci√≥n
                if (gameState !== 'preparation' && gameState !== 'memorization') return;
                
                // Finalizar partida con Escape
                if (e.key === 'Escape') {
                    e.preventDefault();
                    finishGame();
                    return;
                }
                
                // Alternar pantalla completa con F11
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                    return;
                }
                
                // Solo procesar en modo manual
                if (gameMode !== 'manual') return;
                
                // Navegaci√≥n con flechas
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    previousImage();
                    return;
                }
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextImage();
                    return;
                }
            }
            
            // Limpiar event listeners anteriores si existen
            if (window.currentKeyCaptureHandler) {
                document.removeEventListener('keydown', window.currentKeyCaptureHandler);
            }
            
            // Guardar referencia al handler actual
            window.currentKeyCaptureHandler = handleKeyPress;
            
            // Agregar event listener global
            document.addEventListener('keydown', handleKeyPress);
            
            // Retornar funci√≥n para limpiar
            return () => {
                if (window.currentKeyCaptureHandler) {
                    document.removeEventListener('keydown', window.currentKeyCaptureHandler);
                    window.currentKeyCaptureHandler = null;
                }
            };
        }

        // Funci√≥n para navegar a la imagen anterior
        function previousImage() {
            // Verificar si se agot√≥ el tiempo en modo por tiempo
            if (durationMode === 'time-limit') {
                const elapsedTime = ((Date.now() - gameStartTime) - totalPausedTime) / 1000;
                if (elapsedTime >= totalGameSeconds) {
                    finishGame();
                    return;
                }
            }
            
            if (isPreparationPhase) {
                // Si estamos en fase de nombre, retroceder a la imagen anterior
                if (currentImageIndex > 0) {
                    currentImageIndex--;
                    isPreparationPhase = false;
                    document.getElementById('preparation-phase').classList.add('hidden');
                    document.getElementById('memorization-phase').classList.remove('hidden');
                    document.getElementById('prep-navigation').style.display = 'none';
                    document.getElementById('mem-navigation').style.display = 'block';
                    updateDisplay();
                    updateNavigationButtons();
                }
            } else {
                // Si estamos en fase de imagen, retroceder al nombre
                isPreparationPhase = true;
                document.getElementById('memorization-phase').classList.add('hidden');
                document.getElementById('preparation-phase').classList.remove('hidden');
                document.getElementById('mem-navigation').style.display = 'none';
                document.getElementById('prep-navigation').style.display = 'block';
                updatePreparationDisplay();
                updateNavigationButtons();
            }
        }

        // Funci√≥n para navegar a la siguiente imagen
        function nextImage() {
            // Verificar si se agot√≥ el tiempo en modo por tiempo
            if (durationMode === 'time-limit') {
                const elapsedTime = ((Date.now() - gameStartTime) - totalPausedTime) / 1000;
                if (elapsedTime >= totalGameSeconds) {
                    finishGame();
                    return;
                }
            }
            
            if (isPreparationPhase) {
                // Si estamos en fase de nombre, avanzar a la imagen
                isPreparationPhase = false;
                document.getElementById('preparation-phase').classList.add('hidden');
                document.getElementById('memorization-phase').classList.remove('hidden');
                document.getElementById('prep-navigation').style.display = 'none';
                document.getElementById('mem-navigation').style.display = 'block';
                updateDisplay();
                updateNavigationButtons();
                
                // Mostrar bot√≥n de pausa y reiniciar fase
                document.getElementById('mem-pause-btn').style.display = 'inline-block';
                phaseStartTime = 0;
            } else {
                // Si estamos en fase de imagen, avanzar al siguiente nombre
                currentImageIndex++;
                totalImagesSeen++;
                
                if (currentImageIndex < gameImageOrder.length) {
                    isPreparationPhase = true;
                    document.getElementById('memorization-phase').classList.add('hidden');
                    document.getElementById('preparation-phase').classList.remove('hidden');
                    document.getElementById('mem-navigation').style.display = 'none';
                    document.getElementById('prep-navigation').style.display = 'block';
                    updatePreparationDisplay();
                    updateNavigationButtons();
                } else {
                    // Ciclo completado
                    cyclesCompleted++;
                    console.log(`Ciclo ${cyclesCompleted} completado`);
                    
                    // Verificar si debe continuar seg√∫n el modo de duraci√≥n
                    if (durationMode === 'time-limit') {
                        const elapsedTime = ((Date.now() - gameStartTime) - totalPausedTime) / 1000;
                        if (elapsedTime >= totalGameSeconds) {
                            // Tiempo agotado
                            finishGame();
                            return;
                        }
                    } else if (durationMode === 'until-end') {
                        // En modo "hasta que se acaben las im√°genes", terminar despu√©s del primer ciclo
                        finishGame();
                        return;
                    }
                    
                    // En modo por tiempo, verificar si debe cambiar el orden en modo aleatorio
                    if (durationMode === 'time-limit' && currentGameMode === 'random') {
                        shuffleGameOrder();
                    }
                    
                    // Reiniciar para el siguiente ciclo (solo en modo por tiempo)
                    currentImageIndex = 0;
                    isPreparationPhase = true;
                    
                    document.getElementById('memorization-phase').classList.add('hidden');
                    document.getElementById('preparation-phase').classList.remove('hidden');
                    document.getElementById('mem-navigation').style.display = 'none';
                    document.getElementById('prep-navigation').style.display = 'block';
                    updatePreparationDisplay();
                    updateNavigationButtons();
                    
                    // Mostrar bot√≥n de pausa y reiniciar fase
                    document.getElementById('prep-pause-btn').style.display = 'inline-block';
                    phaseStartTime = 0;
                }
            }
        }

        // Actualizar botones de navegaci√≥n
        function updateNavigationButtons() {
            const prevBtn = isPreparationPhase ? 
                document.getElementById('prep-prev-btn') : 
                document.getElementById('mem-prev-btn');
            const nextBtn = isPreparationPhase ? 
                document.getElementById('prep-next-btn') : 
                document.getElementById('mem-next-btn');
            
            if (prevBtn && nextBtn) {
                // En modo manual, el bot√≥n anterior se deshabilita solo en la primera imagen y fase de nombre
                prevBtn.disabled = (currentImageIndex === 0 && isPreparationPhase);
                
                // El bot√≥n siguiente se habilita siempre, excepto en la √∫ltima imagen y fase de imagen
                nextBtn.disabled = (currentImageIndex >= gameImageOrder.length - 1 && !isPreparationPhase);
            }
        }

        // Iniciar juego
        function startGame() {
            // Validar que se hayan cargado im√°genes
            if (images.length === 0) {
                alert('Por favor, carga algunas im√°genes antes de comenzar el juego.');
                return;
            }
            
            // Validar que los campos de tiempo no est√©n vac√≠os en modo autoavance
            if (gameMode === 'auto-advance') {
                if (nameAutoAdvanceTime <= 0) {
                    alert('Por favor, escribe el tiempo para nombre de imagen antes de comenzar el juego.');
                    document.getElementById('name-auto-advance-time').focus();
                    return;
                }
                if (imageAutoAdvanceTime <= 0) {
                    alert('Por favor, escribe el tiempo para imagen antes de comenzar el juego.');
                    document.getElementById('image-auto-advance-time').focus();
                    return;
                }
            }
            
            // Validar que el tiempo total est√© configurado en modo por tiempo
            if (durationMode === 'time-limit' && totalGameMinutes <= 0) {
                alert('Por favor, escribe el tiempo total de juego antes de comenzar.');
                document.getElementById('total-game-minutes').focus();
                return;
            }
            
            // Inicializar variables del juego
            currentImageIndex = 0;
            isPreparationPhase = true;
            gameState = 'preparation';
            cyclesCompleted = 0;
            totalImagesSeen = 0;
            gameStartTime = Date.now();
            
            // Inicializar variables de pausa
            isPaused = false;
            pauseStartTime = 0;
            totalPausedTime = 0;
            phaseStartTime = 0;
            phasePausedTime = 0;
            
            console.log('Iniciando juego con im√°genes:', gameImageNames);
            console.log('N√∫mero de im√°genes:', gameImageOrder.length);
            console.log('Orden del juego:', gameImageNames);
            console.log('Modo de juego:', gameMode);
            if (gameMode === 'auto-advance') {
                console.log('Tiempo configurado - Nombre:', nameAutoAdvanceTime, 'segundos, Imagen:', imageAutoAdvanceTime, 'segundos');
            }
            
            document.getElementById('setup-phase').classList.add('hidden');
            document.getElementById('preparation-phase').classList.remove('hidden');
            
            updatePreparationDisplay();
            
            // Mostrar/ocultar navegaci√≥n seg√∫n el modo
            if (gameMode === 'manual') {
                document.getElementById('prep-navigation').style.display = 'block';
                updateNavigationButtons();
                // Configurar captura global de teclas
                window.cleanupKeyCapture = setupGlobalKeyCapture();
                
                // Iniciar timer para mostrar tiempo total en modo manual
                if (durationMode === 'time-limit') {
                    startManualTimer();
                }
            } else {
                document.getElementById('prep-navigation').style.display = 'none';
                startTimer();
            }
            
            // Mostrar bot√≥n de pausa
            document.getElementById('prep-pause-btn').style.display = 'inline-block';
            
            // Mostrar informaci√≥n del orden seg√∫n el modo
            const orderInfoElements = document.querySelectorAll('#order-info');
            orderInfoElements.forEach(element => {
                if (currentGameMode === 'random') {
                    element.style.display = 'block';
                    element.textContent = 'üîÑ En modo aleatorio, el orden cambia en cada ciclo';
                } else {
                    element.style.display = 'none';
                }
            });
        }

        // Actualizar pantalla de preparaci√≥n (NOMBRE)
        function updatePreparationDisplay() {
            const nameElement = document.getElementById('current-image-name');
            const progress = document.getElementById('prep-progress');
            
            if (currentImageIndex >= 0 && currentImageIndex < gameImageNames.length && currentImageIndex < gameImageOrder.length) {
                const currentName = gameImageNames[currentImageIndex];
                nameElement.textContent = currentName;
                progress.textContent = `Nombre ${currentImageIndex + 1} de ${gameImageNames.length}`;
            } else {
                // Manejar el caso cuando el √≠ndice est√° fuera de rango
                nameElement.textContent = 'Error: √çndice fuera de rango';
                progress.textContent = 'Error';
                // Reiniciar el √≠ndice si es necesario
                if (currentImageIndex >= gameImageNames.length) {
                    currentImageIndex = 0;
                }
            }
        }

        // Actualizar pantalla de memorizaci√≥n (IMAGEN)
        function updateDisplay() {
            const imageElement = document.getElementById('current-image');
            const progress = document.getElementById('progress');
            
            if (currentImageIndex >= 0 && currentImageIndex < gameImageOrder.length && currentImageIndex < gameImageNames.length) {
                const currentImage = gameImageOrder[currentImageIndex];
                const currentName = gameImageNames[currentImageIndex];
                imageElement.src = currentImage;
                progress.textContent = `Imagen ${currentImageIndex + 1} de ${gameImageOrder.length}`;
            } else {
                // Manejar el caso cuando el √≠ndice est√° fuera de rango
                imageElement.src = '';
                progress.textContent = 'Error: √çndice fuera de rango';
                // Reiniciar el √≠ndice si es necesario
                if (currentImageIndex >= gameImageOrder.length) {
                    currentImageIndex = 0;
                }
            }
        }

                         // Timer para ambas fases (solo en modo autoavance)
        function startTimer() {
            // Solo ejecutar en modo autoavance
            if (gameMode !== 'auto-advance') return;
            
            // Limpiar cualquier timer anterior
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // Seleccionar el tiempo correcto seg√∫n la fase
            const currentTime = isPreparationPhase ? nameAutoAdvanceTime : imageAutoAdvanceTime;
            
            // Ajustar tiempo de inicio considerando pausas
            if (phaseStartTime === 0) {
                phaseStartTime = Date.now();
            }
            
            const adjustedStartTime = phaseStartTime;
            const targetTime = adjustedStartTime + (currentTime * 1000);
            
            timerInterval = setInterval(() => {
                // No actualizar si est√° pausado
                if (isPaused) return;
                
                const currentTime = Date.now();
                const remainingTime = Math.max(0, (targetTime - currentTime) / 1000);
                timer = Math.ceil(remainingTime);
                
                // Mostrar tiempo restante de la fase actual
                if (isPreparationPhase) {
                    document.getElementById('prep-timer').textContent = `Tiempo restante: ${remainingTime.toFixed(1)} segundos`;
                } else {
                    document.getElementById('timer').textContent = `Tiempo restante: ${remainingTime.toFixed(1)} segundos`;
                }
                
                // Mostrar tiempo total restante en modo por tiempo
                if (durationMode === 'time-limit') {
                    const totalElapsedTime = ((Date.now() - gameStartTime) - totalPausedTime) / 1000;
                    const totalRemainingTime = Math.max(0, totalGameSeconds - totalElapsedTime);
                    const totalRemainingMinutes = Math.floor(totalRemainingTime / 60);
                    const totalRemainingSeconds = Math.floor(totalRemainingTime % 60);
                    
                    const timeDisplay = `${totalRemainingMinutes}:${totalRemainingSeconds.toString().padStart(2, '0')}`;
                    
                    if (isPreparationPhase) {
                        document.getElementById('prep-timer').textContent += ` | Total: ${timeDisplay}`;
                    } else {
                        document.getElementById('timer').textContent += ` | Total: ${timeDisplay}`;
                    }
                }
                
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    if (isPreparationPhase) {
                        advanceToMemorization();
                    } else {
                        advanceToNextImage();
                    }
                    return;
                }
            }, 100); // Actualizar cada 100ms para mayor precisi√≥n
        }

        // Avanzar de preparaci√≥n (NOMBRE) a memorizaci√≥n (IMAGEN)
        function advanceToMemorization() {
            // Verificar si se agot√≥ el tiempo en modo por tiempo
            if (durationMode === 'time-limit') {
                const elapsedTime = ((Date.now() - gameStartTime) - totalPausedTime) / 1000;
                if (elapsedTime >= totalGameSeconds) {
                    finishGame();
                    return;
                }
            }
            
            isPreparationPhase = false;
            
            document.getElementById('preparation-phase').classList.add('hidden');
            document.getElementById('memorization-phase').classList.remove('hidden');
            
            updateDisplay();
            console.log(`Avanzando de NOMBRE a IMAGEN - √çndice actual: ${currentImageIndex}`);
            
            // Mostrar/ocultar navegaci√≥n seg√∫n el modo
            if (gameMode === 'manual') {
                document.getElementById('mem-navigation').style.display = 'block';
                updateNavigationButtons();
            }
            
            // Mostrar bot√≥n de pausa y reiniciar fase
            document.getElementById('mem-pause-btn').style.display = 'inline-block';
            phaseStartTime = 0;
            
            // Peque√±o delay para asegurar transici√≥n suave
            setTimeout(() => {
                startTimer(); // Reiniciar timer con el nuevo tiempo
            }, 50);
        }

        // Avanzar a la siguiente imagen
        function advanceToNextImage() {
            currentImageIndex++;
            totalImagesSeen++;
            console.log(`Avanzando a siguiente imagen - Nuevo √≠ndice: ${currentImageIndex}`);
            
            if (currentImageIndex < gameImageOrder.length) {
                // Ir a la siguiente imagen (NOMBRE -> IMAGEN)
                isPreparationPhase = true;
                
                document.getElementById('memorization-phase').classList.add('hidden');
                document.getElementById('preparation-phase').classList.remove('hidden');
                
                // Mostrar/ocultar navegaci√≥n seg√∫n el modo
                if (gameMode === 'manual') {
                    document.getElementById('mem-navigation').style.display = 'none';
                    document.getElementById('prep-navigation').style.display = 'block';
                    updateNavigationButtons();
                }
                
                updatePreparationDisplay();
                
                // Peque√±o delay para asegurar transici√≥n suave
                setTimeout(() => {
                    startTimer(); // Reiniciar timer con el nuevo tiempo
                }, 50);
            } else {
                // Ciclo completado
                cyclesCompleted++;
                console.log(`Ciclo ${cyclesCompleted} completado`);
                
                // Verificar si debe continuar seg√∫n el modo de duraci√≥n
                if (durationMode === 'time-limit') {
                    const elapsedTime = ((Date.now() - gameStartTime) - totalPausedTime) / 1000;
                    if (elapsedTime >= totalGameSeconds) {
                        // Tiempo agotado
                        finishGame();
                        return;
                    }
                } else if (durationMode === 'until-end') {
                    // En modo "hasta que se acaben las im√°genes", terminar despu√©s del primer ciclo
                    finishGame();
                    return;
                }
                
                // En modo por tiempo, verificar si debe cambiar el orden en modo aleatorio
                if (durationMode === 'time-limit' && currentGameMode === 'random') {
                    shuffleGameOrder();
                }
                
                // Reiniciar para el siguiente ciclo (solo en modo por tiempo)
                currentImageIndex = 0;
                isPreparationPhase = true;
                
                document.getElementById('memorization-phase').classList.add('hidden');
                document.getElementById('preparation-phase').classList.remove('hidden');
                
                // Mostrar/ocultar navegaci√≥n seg√∫n el modo
                if (gameMode === 'manual') {
                    document.getElementById('mem-navigation').style.display = 'none';
                    document.getElementById('prep-navigation').style.display = 'block';
                    updateNavigationButtons();
                }
                
                updatePreparationDisplay();
                
                // Peque√±o delay para asegurar transici√≥n suave
                setTimeout(() => {
                    startTimer(); // Reiniciar timer con el nuevo tiempo
                }, 50);
            }
        }

        // Terminar juego
        function finishGame() {
            clearInterval(timerInterval);
            
            // Limpiar captura global de teclas
            if (window.cleanupKeyCapture) {
                window.cleanupKeyCapture();
                window.cleanupKeyCapture = null;
            }
            
            document.getElementById('memorization-phase').classList.add('hidden');
            document.getElementById('result-phase').classList.remove('hidden');
            
            const resultMessage = document.getElementById('result-message');
            const elapsedTime = ((Date.now() - gameStartTime) - totalPausedTime) / 1000;
            const elapsedMinutes = Math.floor(elapsedTime / 60);
            const elapsedSeconds = Math.floor(elapsedTime % 60);
            
            let resultText = '';
            
            // Verificar si fue finalizada manualmente
            let wasManuallyFinished = false;
            
            if (durationMode === 'time-limit') {
                // En modo por tiempo, es manual si no se agot√≥ el tiempo
                wasManuallyFinished = elapsedTime < totalGameSeconds;
            } else if (durationMode === 'until-end') {
                // En modo hasta el final, es manual si se finaliz√≥ antes de completar el ciclo
                wasManuallyFinished = cyclesCompleted === 0;
            }
            
            if (wasManuallyFinished) {
                resultText = '¬°Partida finalizada manualmente! ‚èπÔ∏è<br>';
            } else {
                resultText = '¬°Juego completado con √©xito! üéâ<br>';
            }
            
            if (durationMode === 'time-limit') {
                resultText += `Tiempo jugado: ${elapsedMinutes}:${elapsedSeconds.toString().padStart(2, '0')}<br>`;
                resultText += `Ciclos completados: ${cyclesCompleted}<br>`;
                resultText += `Im√°genes vistas: ${totalImagesSeen}`;
            } else {
                resultText += `Ciclos completados: ${cyclesCompleted}<br>`;
                resultText += `Im√°genes vistas: ${totalImagesSeen}<br>`;
                resultText += `Tiempo total: ${elapsedMinutes}:${elapsedSeconds.toString().padStart(2, '0')}`;
            }
            
            resultMessage.className = 'result-message correct-result';
            resultMessage.innerHTML = resultText;
        }
        
        // Reiniciar juego
        function resetGame() {
            gameState = 'setup';
            currentImageIndex = 0;
            timer = 0;
            
            // Limpiar captura global de teclas
            if (window.cleanupKeyCapture) {
                window.cleanupKeyCapture();
                window.cleanupKeyCapture = null;
            }
            
            if (timerInterval) clearInterval(timerInterval);
            
            // Limpiar archivos seleccionados para permitir nueva selecci√≥n
            document.getElementById('image-files').value = '';
            
            // Mantener las im√°genes cargadas y actualizar la vista previa
            if (images.length > 0) {
                const preview = document.getElementById('image-preview');
                preview.innerHTML = '';
                images.forEach((image, index) => {
                    const img = document.createElement('img');
                    img.src = image;
                    img.alt = imageNames[index];
                    preview.appendChild(img);
                });
            }
            
            document.getElementById('result-phase').classList.add('hidden');
            document.getElementById('setup-phase').classList.remove('hidden');
            document.getElementById('view-options').style.display = 'none';
            document.getElementById('image-gallery').style.display = 'none';
            
            // Limpiar bot√≥n de "Mostrar Galer√≠a" si existe
            const showGalleryBtn = document.getElementById('show-gallery-btn');
            if (showGalleryBtn) {
                showGalleryBtn.remove();
            }
        }
    </script>
</body>
</html> 